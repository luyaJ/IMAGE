---
title: 《图解HTTP》
toc: true
date: 2018-05-24 15:41:37
tags: HTTP
categories: 书籍
---

学习《图解HTTP》笔记。

<!--more-->

# 网络基础

通过发送请求获取服务器资源的Web浏览器等，称为**客户端**。

![client-server](http://p983im8gr.bkt.clouddn.com/client-server.png)

## TCP/IP

把互联网相关联的协议集合起来总称为 `TCP/IP`。

TCP/IP 协议族里最重要的一点就是**分层**。按层次分为4层：**应用层、传输层、网络层和数据链路层**。

而这样的分层是有好处的。如果一个互联网只由一个协议统筹，某个地方需要改变设计时，就必须把所有部分整体替换掉。而分层后，只需要把变动的层替换掉就好。

### 应用层

应用层决定了向用户提供应用服务时通信的活动。

TCP/IP 协议族内预存了各类通用的应用服务。比如，`FTP` (File Transfer Protocol，文件传输协议)和 `DNS` (Domain Name System，域名系统)服务就是其中的两类。`HTTP` 协议也处于该层。

### 传输层

传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。

在传输层有两个性质不同的协议：`TCP` (Transmission Control Protocal, 传输控制协议)和 `UDP` (User Data Protocal, 用户数据报协议)。

### 网络层（网络互连层）

网络层用来处理在网络上流动的数据包。数据包是网络传输的最小数据单位。

该层规定了通过怎样的路径（所谓的传输路线）到达对方计算机，并把数据包传送给对方。

与对象计算机之间通过多台计算机或网络设备进行传输时，网络层所起的作用就是在众多的选项内选择一条传输路线。

### 链路层（又名数据链路层，网络接口层）

用来处理连接网络的硬件部分。包括控制操作系统、硬件的设备驱动、NIC（Network Interface Card，网络适配器，即网卡），及光纤等物理可见部分。

### TCP/IP 通信传输流

![通信传输过程](http://p983im8gr.bkt.clouddn.com/trans.png)

利用 `TCP/IP`协议族进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，接收端则往应用层方向走。

我们使用 `HTTP` 举例来说明：
* 首先作为发送端的客户端在应用层（HTTP协议）发出一个想看某个Web页面的 HTTP 请求。
* 接着，为了传输方便，在传输层（TCP协议）把从应用层处收到的数据（HTTP请求报文）进行分割，并在各个报文上打上标记序号及端口号后转发给网络层。
* 在网络层（IP协议），增加作为通信目的地的 MAC 地址后转发给链路层。这样网络的通信请求就准备齐全了。
* 接收端的服务器在链路层接收到数据，按序往上层发送，一直到应用层。当传输到应用层，才能算真正接收到由客户端发送过来的 HTTP 请求。

## 与HTTP关系密切的协议

### 负责传输的IP协议

按层次分，IP（Internet Protocal）网络协议位于网络层。

IP 协议的作用是把各种数据包传送给对方。而要保证确实传送到对方那里，就需要满足两个重要条件：IP 地址和 MAC（Media Access Control Address）地址。

IP 地址指明了节点被分配到的地址，MAC 地址是指网卡所属的固定地址。IP地址和MAC地址进行配对，IP地址可变换，但MAC地址基本上不会更改。

*IP 之间的通信依赖 MAC 地址*。在网络上，通信的双方在同一局域网（LAN）内的情况是很少的，通常是经过多台计算机和网络设备中转才能连接到对方。而在进行中转时，会利用下一站中转设备的 MAC地址 来搜索下一个中转目标。这时，会采用 ARP（Address Resolution Protocal）。ARP 是一种解析地址的协议，根据通信方的 IP 地址就可以反查出对应的 MAC地址。

在到达通信目标前的中转过程，那些计算机和路由器等网络设备只能获悉很粗略的传输路线。这种机制称为**路由选择**。（有点像快递公司的送货过程）

![ARP协议](http://oy9sf0i32.bkt.clouddn.com/MAC.png)

### 确保可靠性的TCP协议

按层次分，TCP 位于传输层，提供可靠的字节流服务。

所谓**字节流服务**（Byte Stream Service）是指，为了方便传输，将大块数据分割成以报文段（segment）为单位的数据包进行管理。而可靠的传输服务是指，能够把数据准确可靠地传给对方。

为了准确无误地将数据送达目标处，TCP 协议采用**三次握手**（three-way handshaking）策略。用 TCP 协议把数据包送出后，它会向对方确认是否成功送达。握手过程中使用了 TCP 的标志—— SYN 和 ACK。

![三次握手策略](http://p983im8gr.bkt.clouddn.com/three-handshaking.png)

解析上图：发送端首先发送一个带SYN标志的数据包给对方。接收端收到后，回传一个SYN/ACK标志的数据包以示传达确认信息。最后，发送端再传一个带有ACK标志的数据包，代表“握手”结束。

### 负责域名解析的DNS服务

DNS 服务是和 HTTP 协议一样位于应用层的协议。它提供域名到 IP 地址之间的解析服务。

用户名通常使用主机名或域名来访问对方的计算机，而不是直接通过IP地址访问。DNS 协议提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。

![DNS协议](http://p983im8gr.bkt.clouddn.com/dns.png)

## 各种协议与HTTP协议的关系

![协议关系](http://oy9sf0i32.bkt.clouddn.com/%E5%8D%8F%E8%AE%AE%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8D%8F%E4%BD%9C.png)

## URI和URL

URI（Uniform Resourse Identifier），统一资源标识符。

URL（Uniform Resource Locator），统一资源定位符。（http://hackr.jp/）

**Uniform**

规定统一的格式可方便处理多种不同类型的资源，而不用根据上下文环境来识别资源指定的访问方式。另外，加入新增的协议方案（如http:或ftp:）也更容易。

URI 就是由某个协议方案表示的资源的定位标识符。协议方案是指访问资源所使用的协议类型名称。

采用 HTTP 协议时，协议方案就是 http 。除此之外还有ftp、mailto、telnet、file等。

URI 用字符串标识某一互联网资源，而 URL 表示资源的地点（互联网上所处的位置）。可见URL是URI的子集。

我们先来了解下绝对 URI 的格式：

![绝对URL格式](http://oy9sf0i32.bkt.clouddn.com/URI.png)

* 使用 `http:` 或 `https:` 等协议方案名获取访问资源时指定协议类型。不区分字母大小写，最后附一个冒号（:）。也可以使用 `data:` 或 `javascript:` 这类指定数据或脚本程序的方案名。
* **登录信息（认证）**：指定用户名和密码作为从服务器端获取资源时必要的登录信息（身份认证）。这项是可选项。
* **服务器地址**：使用绝对 URI 必须指定待访问的服务器地址。地址可以是类似 `hackr.jp` 这种 DNS 可解析的名称，或是 `192.168.1.1` 这类IPv4 地址名，还可以是 `[0:0:0:0:0:0:0:1]` 这样用方括号括起来的 IPv6地址名。
* **服务器端口号**：指定服务器连接的网络端口号。可选项
* **带层次的文件路径**：指定服务器上的文件路径来定位特指的资源。
* **查询字符串**：针对已指定的文件路径内的资源，可以使用查询字符串传入任意参数。可选项
* **片段标识符**：可标记出已获取资源中的子资源（文档内的某个位置）。可选项

# 简单的HTTP协议

## HTTP协议用于客户端和服务器端之间的通信

请求访问文本或图像等资源的一端称为**客户端**，提供资源响应的一端称为**服务端**。

在两台计算机之间使用HTTP协议通信时，在一条通信线路上必有一端是客户端，另一端是服务器端。

![客户端和服务器端之间的通信](http://p983im8gr.bkt.clouddn.com/http%E9%80%9A%E4%BF%A1.png)

下面是客户端发送给某个HTTP服务器端的请求报文内容：
```js
GET /index.htm HTTP/1.1
Host: hackr.jp
```

* `GET` 表示请求服务器的类型，称为**方法**。
* 字符串`/index.htm` 指明了请求访问的资源对象，也叫做请求URI。
* `HTTP/1.1`，是HTTP的版本号，用来提示客户端使用的HTTP协议功能。

所以这段请求的意思就是：请求访问某台HTTP服务器上的`/index.htm` 页面资源。

> 请求报文是由请求方法、请求URI、协议版本、可选的请求首部字段和内容实体构成的。

接收到请求的服务器，会将请求内容的处理结果以响应的形式返回。
```js
HTTP/1.1 200 OK
Date: Tue, 10 Jul 2012 06:50:15 GMT
Content-Length: 362
Content-Type: text/html

<html>
...
```

* `HTTP/1.1` 表示服务器对应的HTTP版本。
* `200 OK` 表示请求的处理结果状态码和原因短语。
* 下一行显示了创建响应的日期时间，是首部字段内的一个属性。
* 接着以一空行分隔，之后的内容称为资源实体的主体。

> 响应报文基本上由协议版本、状态码、用以解释状态码的原因短语、可选的响应首部字段以及实体主体构成。

## HTTP是不保存状态的协议

**HTTP 是一种不保存状态，即无状态协议**。HTTP协议自身不对请求和响应之间的通信状态进行保存。也就是说在 HTTP 这个级别，协议对于发送过的请求或响应都不做持久化处理。

使用 HTTP 协议，每当有新的请求发送时，就会有对应的新响应产生。**协议本身不保留之前一切的请求或响应报文的信息**。这样做得好处是：为了更快地处理大量事务，确保协议的可伸缩性，而特意把 HTTP 协议设计成如此简单的。

`HTTP/1.1` 是无状态协议，为了实现期望的保持状态（登录状态）功能，引入了 `Cookie`技术，这样就可以管理状态了。

## 请求URI定位资源

HTTP 协议使用 URI 定位互联网上的资源。正是因为 URI 的特定功能，在互联网上任意位置的资源都可以访问到。

![URI定位](http://p983im8gr.bkt.clouddn.com/URI%E5%AE%9A%E4%BD%8D.png)

当客户端请求访问资源而发送请求时，URI 需要将作为请求报文中的请求 URI 包含在内。指示请求 URI 的方式有还很多种：

```js
// URI为请求完整的URI
GET http://hackr.jp/index.htm HTTP/1.1
Host: hackr.jp

// 在首部字段Host中写明网络域名或IP地址
GET /index.htm HTTP/1.1
Host: hackr.jp
```

除此之外，如果不是访问特定资源而是对服务器本身发起请求，可以用一个 `*` 来代替 URI。

```js
OPTIONS * HTTP/1.1
```

## 告知服务器意图的HTTP方法

介绍下再HTTP/1.1 可使用的方法。

### GET 获取资源

GET 方法用来请求访问已被 URI 识别的资源。指定的资源经服务器解析后返回响应内容。

如果请求的资源时文本，那就保持原样返回；如果是像 CGI（Common Gateway Interface，通用网关接口）那样的程序，就返回经过执行后输出结果。

### POST 传输实体主体

POST 方法用来传输实体的主体。

虽然 GET 也可以传输实体主体，但是一般不使用 GET 方法进行传输，而是用 POST。虽然说这两者的功能很相似，但 POST 的主要目的并不是获取响应的主题内容。

### PUT 传输文件

PUT 方法用来传输文件。就像在 FTP 协议的文件上传一样，要求在请求报文的主体中包含文件内容，然后保存到请求 URI 的指定位置。

但是由于安全问题，一般 Web 网站不会使用这个方法。

### HEAD 获得报文首部

HEAD 方法和 GET 方法一样，只是不返回报文主体部分。用于确认 URI 的有效性及资源更新的日期时间等。

### DELETE 删除文件

和 PUT 方法相反的方法，按请求 URI 删除指定的资源。

但是 HTTP/1.1 的 DELETE 方法和 PUT 方法一样不带验证机制，所以一般不使用。当配合 Web 应用的验证机制，或遵守 REST 标准时还是有可能会开放使用的。

### OPTIONS 查询支持的方法

查询针对请求 URI 指定的资源支持的方法。

### TRACE 追踪路径

让 Web 服务器端将之前的请求通信环回给客户端的方法。

### CONNECT 要求用隧道协议连接代理

要求在与代理服务器通信时建立隧道，实现用隧道协议进行 TCP 通信。

## 持久连接节省通信量

早期的HTTP协议中，每进行一次 HTTP 通信就要断开一次 TCP 连接。当时都是些容量很小的文本传输，所以即使这样通信影响也不是很大。

但是，现在页面拥有大量的图片，这样每次请求就会增加通信量的开销。所以为了解决 TCP 连接问题，我们使用**持久连接**。

### 持久连接

持久连接（HTTP Persistent Connections），也称为 HTTP keep-alive 或 HTTP connection resue。**持久连接的特点是：只要任意一端没有明确提出断开连接，则保持 TCP 连接状态**。

![1次TCP连接](http://p983im8gr.bkt.clouddn.com/tcp.png)

**持久连接的好处就是**：减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。另外，减少开销的那部分时间，使 HTTP 请求和响应能够更早的结束，这样 web 页面的显示速度也就相应提高了。

在 `HTTP/1.1` 中，所有的连接默认都是持久连接，但在 `HTTP/1.0 `并未标准化。

### 管线化

持久连接使得多数请求以管线化（pipelining）方式发送成为可能。从前发送请求后需要等待并收到响应，才能发送下一个请求。管线化技术出现后，不用等待响应亦可直接发送下一个请求。

这样就可以做到同时并行发送多个请求，而不需要一个接一个地等待响应。

![pipelining](http://p983im8gr.bkt.clouddn.com/pipelining.png)

当请求一个包含10张图片的html页面时，用持久化连接可以让请求更快地结束，而管线化技术则比持久连接还更快。请求数越多，时间差就越明显。

## 使用cookie的状态管理

HTTP 是无状态协议，它不对之前发生过的请求和响应的状态进行管理。也就是，无法根据之前的状态进行本次的请求处理。

所以引入了Cookie技术，Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。

Cookie 会根据从服务器端发送的响应报文内的一个叫做 `Set-Cookie` 的首部字段信息，通知客户端保存 Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送出去。

服务器端发现客户端发送过来的 Cookie 后，会去检查究竟是从哪一个客户端发来的连接请求，然后对比服务器上的记录，最后得到之前的状态信息。

![cookie](http://p983im8gr.bkt.clouddn.com/cookie.png)

# HTTP报文内的HTTP信息

HTTP 通信包括从客户端发往服务器端的请求及从服务器端返回客户端的响应。

## HTTP报文

用于 HTTP 协议交互的信息叫做**HTTP报文**。请求端（客户端）的 HTTP 报文称为请求报文，响应端（服务器端）的 HTTP 报文称为响应报文。

HTTP 报文本身是由多行数据构成的字符串文本（用CR+LF作换行符）。HTTP 报文大致可分为报文首部和报文主体两部分。（通常，并不一定需要报文主体）

![HTTP报文结构](http://p983im8gr.bkt.clouddn.com/HTTP%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.png)

![请求报文和响应报文](http://p983im8gr.bkt.clouddn.com/%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%E5%92%8C%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87.png)

* 请求行：包含用于请求的方法，请求 URI 和 HTTP版本
* 状态行：包含表明响应结果的状态码，原因短语和 HTTP 版本
* 首部字段：包含表示请求和响应的各种关系和属性的各类首部
  * 一般有4种首部 -- 通用首部、请求首部、响应首部和实体首部
* 其他：可能包含 HTTP 的 RFC 里未定义的首部（Cookie等）

## 编码提升传输速率

HTTP 在传输数据时可以按照数据原貌直接传输，但也可以在传输过程中通过编码提升传输速率。（后者优点：能有效地处理大量的访问请求；缺点：编码操作需要计算机来完成，会消耗更多的 CPU 资源）

### 报文主体和实体主体差异

1. 报文(message)

是 HTTP 通信中的基本单位，由 8 位组字节流组成，通过 HTTP 通信传输。

2. 实体(entity)

作为请求或响应的有效荷载数据（补充项）被传输，其内容由实体首部和实体主体组成。

HTTP 报文的主体用于传输请求或响应的实体主体。

通常，报文主体等于实体主体。只有当传输中进行编码操作时，实体主体的内容发生变化，才导致它的报文主体产生差异。

### 压缩传输的内容编码

一般，我们向待发送的邮件内增加附件时，我们一般会先将文件压缩成 ZIP 后再发送。HTTP 协议中有一种被称为**内容编码**的功能也能进行类似的操作。

内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩。内容编码后的实体由客户端接收并负责解码。

常见的内容编码有这几种：`gzip(GUN zip)`、`compress(UNIX 系统的标准压缩)`、`deflate(zlib)`、`identity(不进行编码)`

### 分割发送的分块传输编码

在 HTTP 通信中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面。在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面。

这种把实体主体分块的功能称为**分块传输编码**。

### 发送多种数据的多部分对象集合

发送你邮件时，我们可以在邮件里写入文字并添加多份附件。这是因为采用了 MIME（Multipurpose Internet Mail Extensions，多用途因特网邮件扩展） 机制，它允许邮件处理文本、图片、视频等多个不同类型的数据。

### 内容协商返回最合适的内容

同一个 Web 网站有可能存在着多份相同内容的页面。比如英文版和中文版的 Web 页面，它们内容上虽相同，但使用的语言却不同。

当浏览器的默认语言为英语或中文，访问相同 URI 的 Web 页面时，则会显示对应的英文版或中文版的 Web 页面。这样的机制称为**内容协商**。

内容协商机制是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户最为合适的资源。内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。

# HTTP状态码

HTTP 状态码负责表示客户端 HTTP 请求的返回结果、标记服务器端的处理是否正常、通知出现的错误等工作。

**状态码的类别：**

* 1xx：Information（信息性状态码），接收的请求正在处理
* 2xx：Success（成功状态码），请求正常处理完毕
* 3xx：Redirection（重定向状态码），需要进行附加操作以完成请求
* 4xx：Client Error（客户端错误状态码），服务器无法处理请求（请求有语法错误或请求无法实现）
* 5xx：Server Error（服务器错误状态码），服务器处理请求出错

## 2xx 成功

> 200 OK：表示从客户端发来的请求在服务器端被正常处理了。

在响应报文内，随状态码一起返回的信息会因方法的不同而发生改变。比如，使用 GET 方法，对应请求资源的实体会作为响应返回；而使用 HEAD 方法时，对应请求资源的实体首部不随报文主体作为响应返回（即在响应中只返回首部，不会返回实体的主体部分）。

> 204 No Content：表示服务器接收的请求已成功处理，但是返回的响应报文中不含实体的主体部分。另外，也不允许返回任何实体的主体。

比如，当浏览器发出请求处理后，返回 204 响应，那么浏览器显示的页面不发生更新。一般在只需要从客户端往服务器发送信息，而对客户端不需要发送新信息内容的情况下使用。

> 206 Partial Content：表示客户端进行了范围请求，而服务器成功执行了这部分的GET请求。

## 3xx 重定向

> 301 Moved Permanently：永久重定向。

表示请求的资源已被分配了新的 URI，以后应使用资源现在所指的 URI。也就是说，如果已经把资源对应的 URI 保存为书签，这时应该按 Location 首部字段提示的 URI 重新保存。

> 302 Found：临时重定向

比如，用户把URI保存成书签，但不会像301状态码出现时那样去更新书签，而是仍然保留返回302状态码的页面对应的URI。

> 303 See Other：表示由于请求对应的资源存在着另一个URI，应使用GET方法定向获取请求的资源。

303状态码和302状态码有着相同的功能，但303状态码明确表示客户端应当采用GET方法获取资源，这点与状态码有区别。

当301、302、303响应状态码返回时，几乎所有的浏览器都会把 POST 改成 GET，并删除请求报文内的主体，之后请求会自动再次发送。

301、302标准是禁止将 POST 方法改变成 GET 方法的，但实际使用时大家都会这么做。

> 304 Not Modified：表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但未满足条件的情况。

服务器端资源未改变，可直接使用客户端未过期的缓存。

304状态码返回时，不包含任何响应的主体部分。

> 307 Temporary Redirect：临时重定向

该状态码与302有着相同的含义，但307会遵守浏览器标准，不会从 POST 变成 GET。

## 4xx 客户端错误

> 400 Bad Request：表示请求报文中存在语法错误。

当错误发生时，需修改请求的内容后再次发送请求。

> 401 Unauthorized：表示发送的请求需要有通过 HTTP 认证（BASIC 认证、DIGEST认证）的认证信息。

若之前已进行过1次请求，则表示用户认证失败。

> 403 Forbidden：表示请求资源的访问被服务器拒绝了。

服务器端没有必要给出拒绝的详细理由，但如果想作说明的话，可以在实体的主体部分对原因进行描述，这样就可以让用户看到了。

> 404 Not Found：表示服务器上无法找到请求的资源。

## 5xx 服务器错误

> 500 Internal Server Error：表示服务器端在执行请求时发生了错误。也有可能是Web应用存在的bug或某些临时的故障。

> 503 Service Unavailable：表示服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。

# 与HTTP协作的Web服务器

一台 Web 服务器可搭建多个独立域名的 Web 网站，也可作为通信路径上的中转服务器提升传输速率。

## 通信数据转发程序

HTTP 通信时，除客户端和服务器以外，还有一些用于通信数据转发的应用程序，例如代理、网关和隧道。它们可以配合服务器工作。

这些应用程序和服务器可以将请求转发给通信线路上的下一站服务器，并且能接收从那台服务器发送的响应再转发给客户端。

### 代理

**代理**是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。

### 网关

网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。

### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转的，并保持双方通信连接的应用程序。