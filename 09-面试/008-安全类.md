# CSRF

CSRF（Cross-site request forgery），通常称为跨站请求伪造。

## 攻击原理

![CSRF攻击原理](http://oy9sf0i32.bkt.clouddn.com/CSRF.png)

用户是网站 A 的注册用户，我需要通过身份认证登录网站 A，A 网站核查身份是否正确，如果正确就下发 Cookie，Cookie 会保存在用户的浏览器中。

上面完成了一次身份认证的过程。当用户未退出 A 网站之前，在同一浏览器。

用户访问了网站 B，B 存在引诱点击（含攻击性代码），发送一个请求要求访问第三方站点A，链接至 A 网站的 API 接口。当用户点击了链接之后，访问 A 网站，A 网站会自动上传 Cookie，进行身份确认。

会引起 CSRF 攻击满足以下两点：

* 网站中的接口存在漏洞
* 在网站中确实登录过

## 防御措施

> 1. HTTP Referer 验证：

在 HTTP 头有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。需要防御 CSRF 攻击，只需要验证其 Referer 值，如果是同一站点下的域名，说明请求合法，反之不合法，拒绝请求。

这种方法简单易行，不需要改变已有的代码和逻辑，非常便捷。但是并不是万无一失的，Referer 的值由浏览器提供，不能保证浏览器本身没有安全漏洞。还有就是用户本身可以设置发送请求时不提供 Referer。

> 2. Token 验证：

访问过某网站或注册过某网站，服务器会自动向本地存一个 Token。当你访问接口时，没有带 Token，它不会让你通过验证。

缺点就是难以保证 Token 本身的安全，因为在论坛中，用户可以发布自己的言论（自己的网站地址）。

> 3. 隐藏令牌：

隐藏在 http 头上

# XSS

XSS（cross-site scripting），跨站脚本攻击。

## 攻击方式

> 1.反射性

发出请求时，**XSS 代码出现在 URL 中**，作为输入提交到服务器端，**服务器端解析后响应**（解析 js 代码），XSS 代码随响应内容一起传回给浏览器，最后浏览器解析执行 XSS 代码。这个过程像一次反射，故叫反射性 XSS。

我们通过 Nodejs 来仿 XSS 攻击。

[慕课网视频地址](https://www.imooc.com/video/14368)

> 2.存储型

存储型 XSS 和反射型 XSS 的差别仅在于，提交的代码会存储在服务器端（数据库、内存、文件系统等），下次请求目标页面时不同再提交 XSS 代码。

## 攻击原理

不需要做任何登录验证，核心：向页面注入脚本（比如，评论区注入 JS）

## 防御措施

> 1. 编码

对用户输入的数据进行 HTML Entity 编码。比如将 `<` 转换成转义字符 `&lt;`。

> 2. 过滤

移除用户上传的 DOM 属性，如 onerror 等；移除用户上传的 Style 节点、Script 节点、Iframe 节点。

> 3. 校正

* 避免直接对 HTML Entity jiema
* 使用 DOM Parse 转换，校正不配对的 DOM 标签。